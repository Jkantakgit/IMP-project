<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camera Console</title>
    <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();function c(l,t,e=8e3){const i=new AbortController,o=setTimeout(()=>i.abort(),e),s={...t||{},signal:i.signal};return fetch(l,s).finally(()=>clearTimeout(o))}class p{photos=[];currentTab="live";loading=!1;error=null;busy=!1;statusMessage=null;clientTimeOffsetMs=null;constructor(){this.init()}async init(){document.getElementById("root").innerHTML=this.render(),this.attachEventListeners(),this.syncTime();try{await this.fetchDeviceTime()}catch{}}attachEventListeners(){document.getElementById("tab-live")?.addEventListener("click",()=>{this.currentTab!=="live"&&(this.currentTab="live",this.syncTime(),this.update())}),document.getElementById("tab-photos")?.addEventListener("click",()=>{this.currentTab!=="photos"&&(this.stopMjpeg(),this.currentTab="photos",this.update())}),document.getElementById("btn-take")?.addEventListener("click",()=>{this.busy||this.takeMedia()}),document.getElementById("btn-refresh-photos")?.addEventListener("click",()=>{this.loadPhotos()})}async fetchPhotosList(){const t=await c("/photos",{method:"GET",headers:{Accept:"application/json"}},1e4);if(!t.ok)throw new Error(`Failed (${t.status})`);const e=await t.text();if(!e)return[];const i=JSON.parse(e);return(Array.isArray(i.files)?i.files:Array.isArray(i)?i:[]).map((s,a)=>typeof s=="string"?s:String(s.name??s.id??a))}_photosCache=null;async syncTime(){try{this.statusMessage="Syncing device timeâ€¦",this.update();const t={time_ms:Date.now()},e=await c("/time",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},5e3);if(!e.ok)throw new Error(`Failed to sync (${e.status})`);try{await this.fetchDeviceTime()}catch{}this.statusMessage="Device time synced",this.update(),await this.sleep(800),this.statusMessage=null,this.update()}catch(t){console.error("[UI] /time sync error:",t),this.statusMessage=t instanceof Error?`Time sync failed: ${t.message}`:"Time sync failed",this.update(),await this.sleep(1500),this.statusMessage=null,this.update()}}async fetchDeviceTime(){const t=await c("/time",{method:"GET",headers:{Accept:"application/json"}},5e3);if(!t.ok)throw new Error(`Failed to get time (${t.status})`);const i=(await t.json().catch(()=>null))?.time_ms;if(typeof i=="number")this.clientTimeOffsetMs=i-Date.now(),console.log("[UI] device time offset (ms):",this.clientTimeOffsetMs);else throw new Error("Invalid /time response")}async loadPhotos(){this.loading=!0,this.error=null,this.statusMessage=null,this.update();try{const t=await this.fetchPhotosList();this.photos=t.map(e=>{const i=String(e),s=i.replace(/\.jpg$/i,"").replace(/x/g," ").replace(/_/g,":");return{id:i,name:s}}),this.photos=this.photos.filter((e,i,o)=>o.findIndex(s=>s.id===e.id)===i)}catch(t){console.error("[UI] /photos error:",t),this.error=t instanceof Error?t.message:"Unknown error",this.photos=[]}finally{this.loading=!1,this.update()}}async takeMedia(){const t="/photo";try{console.log("[UI] Trigger",t),this.busy=!0,this.statusMessage="Fetching device timeâ€¦",this.update();let e;if(this.clientTimeOffsetMs!==null)e=Date.now()+this.clientTimeOffsetMs;else{const n=await c("/time",{method:"GET",headers:{Accept:"application/json"}},5e3);if(!n.ok)throw new Error(`Failed to get time (${n.status})`);e=(await n.json().catch(()=>null))?.time_ms??Date.now(),typeof e=="number"&&(this.clientTimeOffsetMs=e-Date.now())}this.statusMessage="Preparing capture requestâ€¦",this.update();const i=`capture:${e}`,o=i.startsWith("{")?"application/json":"text/plain",s=await c(t,{method:"POST",headers:{"Content-Type":o},body:i},15e3),a=await s.text();let r=null;try{r=a?JSON.parse(a):null}catch{r=null}if(!s.ok){this.error=r?.reason||`Failed (${s.status})`,this.statusMessage=null,this.busy=!1,this.update();return}const h=r?.status||(s.status===202?"accepted":"ok"),d=r?.path||null;if(h==="rejected"){this.statusMessage=`Rejected: ${r?.reason??"outside window"}`,this.busy=!1,this.update();return}if(h==="scheduled"){this.statusMessage=`Capture scheduled for ${r?.scheduled_for??"future"}`,this.busy=!1,this.update();return}if(d){const n=String(d).split("/").pop()||"";this.statusMessage="Capture accepted â€” waiting for file to appear...",this.update(),await this.waitForFile(n,12,1e3)?(this.statusMessage="Capture completed",this.currentTab==="photos"&&await this.loadPhotos()):this.statusMessage="Capture accepted but file not found yet. Refresh to check."}else this.currentTab==="photos"&&await this.loadPhotos();this.busy=!1,this.update()}catch(e){console.error("[UI] trigger error:",e),this.error=e instanceof Error?e.message:"Unknown error",this.statusMessage=null,this.busy=!1,this.update()}}sleep(t){return new Promise(e=>setTimeout(e,t))}async waitForFile(t,e=6,i=2e3){if(!t)return!1;for(let o=0;o<e;o++){try{const s=Date.now();let a;if(this._photosCache&&s-this._photosCache.ts<5e3?a=this._photosCache.list:(a=await this.fetchPhotosList(),this._photosCache={ts:s,list:a}),a.find(r=>r===t))return!0}catch{}await this.sleep(i)}return!1}update(){const t=document.getElementById("root");if(!t)return;const e=window.scrollY;if(t.innerHTML=this.render(),this.attachEventListeners(),window.scrollTo(0,e),this.currentTab==="live"){const i=document.getElementById("mjpeg");i&&!i.src&&(i.src=`http://${location.hostname}:8081/`)}}stopMjpeg(){const t=document.getElementById("mjpeg");if(t)try{t.src="",t.remove()}catch{}}render(){const t=this.photos;return`
      <div class="page">
        <header class="hero">
          <p class="eyebrow">Camera console</p>
          <div class="hero__row">
            <div>
              <h1>Photo library</h1>
              <p class="subhead">Browse and download photos from your device (download-only).</p>
              ${this.statusMessage?`<p class="status">${this.statusMessage}</p>`:""}
            </div>
          </div>
        </header>

        <nav class="tabs">
          <button class="tab ${this.currentTab==="live"?"active":""}" id="tab-live">Live</button>
          <button class="tab ${this.currentTab==="photos"?"active":""}" id="tab-photos">Photos</button>
        </nav>

        ${this.currentTab==="live"?`
          <section class="layout">
            <main class="panel">
              <div class="panel__header"><h2>Live stream</h2>
                <div class="hero__actions">
                  <button class="primary" id="btn-take">ðŸ“¸ Take photo</button>
                </div>
              </div>
              <div class="player__body"><div class="player-grid"><div class="player-preview">
                <img id="mjpeg" src="http://${location.hostname}:8081/" alt="Live stream" style="max-width:100%;height:auto;"/>
              </div></div></div>
            </main>
          </section>
        `:`
          <section class="layout">
            <main class="panel">
              <div class="panel__header">
                <h2>Available photos</h2>
                <span class="badge">${t.length}</span>
                <div style="float:right">
                  <button class="secondary" id="btn-refresh-photos">Refresh</button>
                </div>
              </div>
              ${this.loading?'<p class="muted">Loadingâ€¦</p>':""}
              ${this.error?`<p class="error">${this.error}</p>`:""}
              ${!this.loading&&!this.error&&t.length===0?'<p class="muted">No items found.</p>':""}
              <ul class="photo-list">
                ${t.map(e=>`
                    <li>
                      <a class="photo-link" href="/photo/${encodeURIComponent(e.id)}">${e.name}</a>
                    </li>
                  `).join("")}
              </ul>
            </main>
          </section>
        `}
      </div>
    `}}new p;</script>
    <style rel="stylesheet" crossorigin>:root{--bg:#f4f6fb;--panel:#ffffff;--muted:#6b7280;--border:#e6e9ef;--text:#0f1724;--primary:#2563eb;--accent:#1e40af;--danger:#dc2626}*{box-sizing:border-box}body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;margin:0}.page{max-width:1100px;margin:0 auto;padding:1.25rem}.hero{background:var(--panel);border:1px solid var(--border);padding:1rem;margin-bottom:1rem;border-radius:8px}.hero__row{display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;align-items:center}.hero__actions{display:flex;gap:.5rem}h1{font-size:1.5rem;margin:0;color:var(--text)}h2{font-size:1.05rem;margin:0}.subhead{color:var(--muted);font-size:.95rem;margin-top:.25rem}.eyebrow{text-transform:uppercase;font-size:.75rem;color:var(--muted);letter-spacing:.04em}.tabs{display:flex;gap:.5rem;border-bottom:1px solid var(--border);padding-bottom:.5rem;margin-bottom:1rem}.tab{background:none;border:none;color:var(--muted);padding:.5rem 1rem;cursor:pointer;border-bottom:3px solid transparent;font-weight:600}.tab.active{color:var(--primary);border-color:var(--primary)}.layout{display:grid;grid-template-columns:300px 1fr;gap:1rem}.panel{background:var(--panel);border:1px solid var(--border);padding:1rem;border-radius:8px}.panel__header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.badge{background:var(--primary);color:#fff;padding:.2rem .6rem;border-radius:999px;font-size:.8rem}.video-list{list-style:none;padding:0;margin:0}.video-item{width:100%;display:flex;align-items:center;justify-content:space-between;text-align:left;padding:.65rem;border:1px solid var(--border);background:transparent;margin-bottom:.5rem;border-radius:6px;cursor:pointer}.video-item:hover{background:#f3f6ff}.video-item.active{border-color:var(--primary);background:#eef4ff}.video-name{display:block;font-weight:600}.video-id{color:var(--muted);font-size:.85rem}.player__body{margin-top:.5rem}.player-grid{display:flex;gap:1rem;align-items:flex-start}.player-preview{flex:1}.preview-placeholder{background:#f8fafc;border:1px solid var(--border);padding:2rem;border-radius:8px;color:var(--muted);text-align:center}.player-actions{width:260px;display:flex;flex-direction:column;gap:.75rem}video,img{width:100%;border:1px solid var(--border);background:#000;border-radius:6px}.meta{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:.75rem}.meta__value{font-weight:600}.muted{color:var(--muted)}.error{color:var(--danger);font-weight:700}.empty-state{border:1px dashed var(--border);padding:2rem;text-align:center;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfbff)}.hero__actions .primary,.primary{background:var(--primary);color:#fff;border:none;padding:.5rem .8rem;border-radius:6px;cursor:pointer;font-weight:600}.status{margin-top:.5rem;color:var(--accent);font-weight:600}.secondary{background:transparent;border:1px solid var(--border);padding:.45rem .7rem;border-radius:6px;cursor:pointer;color:var(--accent);font-weight:600}.primary:focus,.secondary:focus,.video-item:focus{outline:3px solid rgba(37,99,235,.15);outline-offset:2px}@media(max-width:768px){.layout{grid-template-columns:1fr}.hero__row{flex-direction:column;align-items:flex-start}.hero__actions{width:100%;justify-content:flex-start}}</style>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
